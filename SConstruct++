env = Environment()
env.Append(CPPPATH = ["src"])
env.Append(CPPPATH = ["/usr/include"])
Export("env")
test_env = Environment()
test_env["have_boost_test"] = False
Export("test_env")

import distutils.sysconfig
env.AppendUnique(CPPPATH = distutils.sysconfig.get_python_inc())
version = distutils.sysconfig.get_config_var("VERSION")
if not version:
    version = sys.version[:3]
if env["PLATFORM"] == "win32":
    version = version.replace('.', '')
env.AppendUnique(LIBPATH = distutils.sysconfig.get_config_var("LIBDIR") or \
                               os.path.join(distutils.sysconfig.get_config_var("prefix"), "libs") )
env.AppendUnique(LIBS = "python" + version + "m")
env.AppendUnique(LIBS = ["boost_filesystem", "boost_system", "boost_thread", "boost_program_options", "sqlite3"])
env.AppendUnique(CPPPATH = ["thirdparty/pybind11/include"])
env.AppendUnique(CCFLAGS = Split("-Wall -O2 -march=native -Wno-deprecated -Wno-parentheses -pthread -fvisibility=hidden"), LINKFLAGS = ["-pthread"], CPPDEFINES = ["BOOST_FILESYSTEM_VERSION=3"])
env.Append(CXXFLAGS = ["-std=c++14"])
#env.Append(CCFLAGS = ["-pg"], LINKFLAGS = ["-pg"])

SConscript("src/SConscript")
config_hpp = '''
#ifndef SRC_CONFIG_HPP
#define SRC_CONFIG_HPP

#define PYTHON_MODULES_PATH "''' + env.Dir("python_modules").abspath + '''"

#endif
'''
env.Command(env.File("src/config.hpp"), env.Value(config_hpp), lambda target, source, env: open(target[0].path, "w").write(source[0].get_contents()))
